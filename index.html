<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Briefing — Arribos & Salidas</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .controls{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap}
    .date-input{padding:8px;border:1px solid var(--border);border-radius:10px}
    .apply-btn{background:#111;color:#fff;border:0;padding:8px 14px;border-radius:10px;font-weight:600;cursor:pointer}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <img src="assets/logo.png" class="logo" alt="logo">
      <div><h1>Briefing — Arribos & Salidas</h1></div>
    </div>
    <div class="controls">
      <input type="date" id="inputFecha" class="date-input" />
      <button class="apply-btn" id="btnAplicarFecha">Aplicar fecha</button>
      <button class="refresh-btn" id="btnRefresh">Actualizar</button>
    </div>
  </header>

  <div class="tabs" role="tablist">
    <button class="tab active" data-tab="arribos">Arribos</button>
    <button class="tab" data-tab="salidas">Salidas</button>
    <button class="tab" data-tab="historial">Historial</button>
  </div>

  <div class="container">
    <section class="card" id="cardArribos">
      <strong>Arribos</strong>
      <div class="table-wrap">
        <table id="tblArribos"><thead></thead><tbody></tbody></table>
      </div>
    </section>

    <section class="card" id="cardSalidas" style="display:none">
      <strong>Salidas</strong>
      <div class="table-wrap">
        <table id="tblSalidas"><thead></thead><tbody></tbody></table>
      </div>
    </section>

    <section class="card" id="cardHistorial" style="display:none">
      <div class="row">
        <strong>Historial</strong>
        <input type="text" id="searchInput" placeholder="Buscar vuelo o matrícula...">
      </div>
      <div class="table-wrap">
        <table id="tblHistorial"><thead></thead><tbody></tbody></table>
      </div>
    </section>
  </div>
</div>

<script src="js/app.js" defer></script>

<script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzJzfLbZWUUXGo94Lo8VTADQCgE9d_NCmpson6SUB7zamQvkOigrQUjFdKQ2CAeT7PsKQ/exec";

  function handleGASData(rows){
    window.__GAS_ROWS__ = rows || [];
    if (window.__loadFromJSONP) window.__loadFromJSONP(window.__GAS_ROWS__);
  }

  // ✅ callback de update: muestra el valor exacto de A1
  function handleGASUpdate(res){
    if (res && res.ok) {
      alert("Fecha aplicada en A1: " + (res.set || ""));
      requestGAS();
    } else {
      alert("No se pudo aplicar la fecha" + (res && res.error ? " ("+res.error+")" : ""));
    }
  }

  function requestGAS(){
    const s = document.createElement('script');
    s.async = true;
    s.src = GAS_URL + "?callback=handleGASData&_ts=" + Date.now();
    document.body.appendChild(s);
  }

  function updateA1(dateStr){
    const s = document.createElement('script');
    s.async = true;
    s.src = GAS_URL + "?action=update&date=" + encodeURIComponent(dateStr) + "&callback=handleGASUpdate&_ts=" + Date.now();
    document.body.appendChild(s);
  }

  window.addEventListener('DOMContentLoaded', function(){
    const inputFecha = document.getElementById('inputFecha');
    const btnAplicar = document.getElementById('btnAplicarFecha');
    const btnRefresh = document.getElementById('btnRefresh');

    btnAplicar.addEventListener('click', function(){
      const val = inputFecha.value;
      if (!val) { alert("Seleccioná una fecha."); return; }
      updateA1(val);
    });

    btnRefresh?.addEventListener('click', requestGAS);

    requestGAS();
    setInterval(requestGAS, 120000); // auto-refresh cada 2 min
  });
</script>
</body>
</html>
