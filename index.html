<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Briefing — Arribos & Salidas</title>

  <!-- HARD RESET para Android Chrome: usar ?reset=1 o ?dev=1 una vez -->
  <script>
  (function(){
    const q = new URLSearchParams(location.search);
    const HARD = q.has('reset') || q.has('dev');
    const SCOPE_HINT = location.origin + '/briefing3.0/';

    async function hardReset(){
      try {
        if ('serviceWorker' in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs
            .filter(r => (r.scope||'').indexOf(SCOPE_HINT)===0)
            .map(r => r.unregister()));
        }
        if (window.caches && caches.keys) {
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
        }
        try { localStorage.clear(); } catch(e){}
        try { sessionStorage.clear(); } catch(e){}
        q.delete('reset'); q.delete('dev');
        const u = new URL(location.href);
        u.search = q.toString();
        u.searchParams.set('_', Date.now());
        location.replace(u.toString());
      } catch(e){
        console.warn('[hard-reset] fallo parcial:', e);
      }
    }

    if (HARD) hardReset();
  })();
  </script>

  <!-- CSS con versión para bustear caché -->
  <link rel="stylesheet" href="css/styles.css?v=2025-10-02-03">

  <style>
    .controls{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap}
    .date-input{padding:8px;border:1px solid var(--border);border-radius:10px}
    .apply-btn{background:#111;color:#fff;border:0;padding:8px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    .legend{display:none;gap:12px;align-items:center;justify-content:center;font-size:.9rem;margin-top:6px}
    .legend .sw{display:inline-block;width:16px;height:16px;border-radius:4px;border:1px solid var(--border);margin-right:6px;vertical-align:middle}
    .legend .micro{background:rgba(139,92,246,.16);border-color:rgba(139,92,246,.35)}
    .micro-cell{background:rgba(139,92,246,.16);border:1px solid rgba(139,92,246,.35);border-radius:6px;padding:4px 8px;font-weight:700}
    #net-error{position:fixed;left:0;right:0;bottom:0;padding:10px 14px;background:#fee2e2;color:#991b1b;border-top:1px solid #fecaca;font-weight:600;z-index:9999;display:none}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <img src="assets/logo.png" class="logo" alt="logo">
      <div><h1>Briefing — Arribos & Salidas</h1></div>
    </div>
    <div class="controls">
      <input type="date" id="inputFecha" class="date-input" />
      <button class="apply-btn" id="btnAplicarFecha">Aplicar fecha</button>
      <button class="refresh-btn" id="btnRefresh">Actualizar</button>
    </div>
    <div class="legend" id="legendMicros">
      <span><span class="sw micro"></span>vuelo pintado requiere traslado de pasajeros ato-ato</span>
    </div>
  </header>

  <div class="tabs" role="tablist">
    <button class="tab active" data-tab="arribos" role="tab" aria-selected="true">Arribos</button>
    <button class="tab" data-tab="salidas" role="tab" aria-selected="false">Salidas</button>
    <button class="tab" data-tab="historial" role="tab" aria-selected="false">Historial</button>
  </div>

  <div class="container">
    <section class="card" id="cardArribos" role="tabpanel" aria-labelledby="Arribos">
      <strong>Arribos</strong>
      <div class="table-wrap">
        <table id="tblArribos"><thead></thead><tbody></tbody></table>
      </div>
    </section>

    <section class="card" id="cardSalidas" role="tabpanel" aria-labelledby="Salidas" style="display:none">
      <strong>Salidas</strong>
      <div class="table-wrap">
        <table id="tblSalidas"><thead></thead><tbody></tbody></table>
      </div>
    </section>

    <section class="card" id="cardHistorial" role="tabpanel" aria-labelledby="Historial" style="display:none">
      <div class="row">
        <strong>Historial</strong>
        <input type="text" id="searchInput" placeholder="Buscar vuelo o matrícula...">
      </div>
      <div class="table-wrap">
        <table id="tblHistorial"><thead></thead><tbody></tbody></table>
      </div>
    </section>
  </div>
</div>

<!-- Banner de error -->
<div id="net-error"></div>

<!-- Tu lógica principal de UI (versión con bust de caché) -->
<script src="js/app.js?v=2025-10-02-03" defer></script>

<!-- Loader JSONP robusto + UI bootstrap -->
<script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbxhNByp7sqrxfyMDddqV6O9OsGmqIzEcfrn49TcYN9qUettWe4iETKaNems1WWrtMi8/exec";
  const DEV = new URLSearchParams(location.search).has('dev');

  function showErrorBanner(msg){
    const b = document.getElementById('net-error');
    if (!b) return;
    b.textContent = msg;
    b.style.display = 'block';
  }

  (function devTools(){
    if (!DEV) return;
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister()));
    }
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('script[src],link[rel="stylesheet"][href]').forEach(el=>{
        const attr = el.tagName==='SCRIPT'?'src':'href';
        try {
          const u = new URL(el.getAttribute(attr), location.href);
          u.searchParams.set('_', Date.now());
          el.setAttribute(attr, u.toString());
        } catch(e){}
      });
      console.info('[DEV] sin SW y sin caché');
    });
  })();

  function jsonpLoad({url, callbackName, id, timeoutMs = 12000, onError}) {
    const prev = document.getElementById(id);
    if (prev) prev.remove();

    const u = new URL(url, location.href);
    u.searchParams.set('_ts', Date.now());
    u.searchParams.set('callback', callbackName);

    if (location.protocol === 'https:' && u.protocol === 'http:') {
      console.error('[JSONP] Mixed Content bloqueado en Chrome:', u.href);
      onError?.(new Error('MixedContent'));
      return;
    }

    const s = document.createElement('script');
    s.id = id;
    s.async = true;
    s.src = u.toString();

    let done = false;
    const to = setTimeout(() => {
      if (done) return; done = true; s.remove();
      onError?.(new Error('Timeout'));
    }, timeoutMs);

    s.onerror = () => {
      if (done) return; done = true; clearTimeout(to); s.remove();
      onError?.(new Error('NetworkError'));
    };

    document.body.appendChild(s);
  }

  // Callbacks globales para GAS (usados por app.js)
  window.handleGASData = function(rows){
    window.__GAS_ROWS__ = rows || [];
    if (typeof window.__loadFromJSONP === 'function') {
      try { window.__loadFromJSONP(window.__GAS_ROWS__); }
      catch (e) { console.error('Error en __loadFromJSONP:', e); }
    }
  };

  window.handleGASUpdate = function(res){
    if (res && res.ok) {
      alert("Fecha aplicada en A1: " + (res.set || ""));
      requestGAS();
    } else {
      alert("No se pudo aplicar la fecha" + (res && res.error ? " ("+res.error+")" : ""));
    }
  };

  function requestGAS(){
    jsonpLoad({
      url: GAS_URL,
      callbackName: 'handleGASData',
      id: 'jsonp-gas-data',
      onError(err){
        console.error('[GAS] Error cargando datos:', err && err.message);
        showErrorBanner('No se pueden cargar datos de Google Apps Script. Probá entrar una vez con ?reset=1 o ?dev=1. Si sigue, probá otra red (datos/Wi-Fi).');
      }
    });
  }

  function updateA1(dateStr){
    const url = GAS_URL + "?action=update&date=" + encodeURIComponent(dateStr);
    jsonpLoad({
      url,
      callbackName: 'handleGASUpdate',
      id: 'jsonp-gas-update',
      onError(err){
        console.error('[GAS] Error aplicando fecha:', err && err.message);
        showErrorBanner('No se pudo contactar al servicio para aplicar la fecha. Reintentá o usá ?dev=1.');
        alert('No se pudo contactar al servicio. Reintentá.');
      }
    });
  }

  window.addEventListener('DOMContentLoaded', function(){
    const inputFecha   = document.getElementById('inputFecha');
    const btnAplicar   = document.getElementById('btnAplicarFecha');
    const btnRefresh   = document.getElementById('btnRefresh');
    const legendMicros = document.getElementById('legendMicros');
    const tabs         = document.querySelectorAll('.tab');

    btnAplicar.addEventListener('click', function(){
      const val = inputFecha.value;
      if (!val) { alert("Seleccioná una fecha."); return; }
      updateA1(val);
    });

    btnRefresh && btnRefresh.addEventListener('click', requestGAS);

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.card').forEach(c => c.style.display = 'none');
        const selected = tab.dataset.tab;
        document.getElementById('card' + selected.charAt(0).toUpperCase() + selected.slice(1)).style.display = '';
        legendMicros.style.display = (selected === 'arribos') ? 'flex' : 'none';
      });
    });

    requestGAS();                    // primera carga
    setInterval(requestGAS, 120000); // refresco cada 2 minutos
  });
</script>
</body>
</html>
